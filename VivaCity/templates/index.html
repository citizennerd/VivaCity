<!DOCTYPE HTML>
<html>
	<head>
		<title> VivaCity </title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
		<script src="https://github.com/andyet/ICanHaz.js/raw/master/ICanHaz.min.js"></script>
		<script src="/static/js/OpenLayers.js"></script>
		<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>
		<script src="https://raw.github.com/cowboy/jquery-hashchange/v1.3/jquery.ba-hashchange.js"></script>
		<style>
			@import url(/static/css/theme/default/style.css);
			@import url(http://fonts.googleapis.com/css?family=Josefin+Sans:700);
			body {
				margin: 0 0 0 0;
				font-family: 'Josefin Sans', sans-serif;
				overflow:hidden;
			}
			header {
				height: 50px;
				background-color: black;
				color: white;
				font-size: xx-large;
				vertical-align: middle;
			}
			
			#search{
				
				position: relative;
				display: inline-block;
				font-family: 'Josefin Sans', sans-serif;
				font-size: x-large;
				left: 30px;
			}

			.main_title {
				display: inline-block;
				top: -6px;
				position: relative;
				left: 8px;
			}
			.uth {
				display: inline-block;
				top: -6px;
				position: relative;
				right: 8px;
				float:right;
			}

			.area_title {
				display: inline-block;
				top: -6px;
				position: relative;
				left: 30px;
				color: #DDD;
				cursor:move;
			}
	
			.cmd_bar{
				z-index: 10000;
			}

			#map {
				width: 100%;
				left:35px;
				top:50px;
				position:absolute;
			}
			#nav_ctrl{
				position:absolute;
				width:150px;
				height:150px;
				background-color:#bcd;
				bottom:16px;
				left:35px;
			}
			#btm_ctrl{
				position:absolute;
				width:600px;
				height:150px;
				background-color:#bcd;
				bottom:16px;
				left: 210px;
				font-family:calibri, arial, helvetica, sans-serif;
				font-size:small;
			}
				
				/*
			#int_ctrl{
				position:absolute;
				width:5px;
				left:15px;
				bottom:166px;
				height:500px;
				background-color:#bcd;
			}
			.erg{
				background-color:red;
			}
			
			#int_ctrl>.btn{
				position:relative;
				margin-top:20px;
				width:60px;
				height:35px;
				left:-15px;
				background-color:orange;
			}
			.btn>.btn{
				position: relative;
				left: 85px;
				width: 60px;
				height: 35px;
				background-color: cyan;
				margin-top: 20px;
			}
			#int_ctrl>.erg{
				margin-top:50px;
				background-color:red;
			}
			*/
			.hide_btn{
				position:absolute;
				width:25px;
				height:25px;
				background-color:#bcd;
			}
			#hide_all{
				
				left:0;
				bottom: 16px;
				z-index:10001;
				background-image:url(/static/img/x.png);
			}
			#hide_int{
				left:0;
				bottom:125px;
				background-image:url(/static/img/x.png);
			}
			#hide_btm{
				left:125px;
				bottom:0px;
				background-image:url(/static/img/x.png);
			}
			
			#op_zoom_in{
				width:25px;
				height:25px;
				position:absolute;
				background-color:#bcd;
				bottom:75px;
				left:62px;
				background-image:url(/static/img/plus.png);
			}
			#op_zoom_out{
				width:25px;
				height:25px;
				position:absolute;
				background-color:#bcd;
				bottom:50px;
				left:62px;
				background-image:url(/static/img/minus.png);
			}
			#op_e{
				width:25px;
				height:50px;
				position:absolute;
				background-color:#bcd;
				bottom:50px;
				left:100px;
				background-image:url(/static/img/e.png);
			}
			
			#op_w{
				width:25px;
				height:50px;
				position:absolute;
				background-color:#bcd;
				bottom:50px;
				left:25px;
				background-image:url(/static/img/w.png);
			}
			
			#op_n{
				width:50px;
				height:25px;
				position:absolute;
				background-color:#bcd;
				bottom:100px;
				left:50px;
				background-image:url(/static/img/n.png);
			}
			
			#op_s{
				width:50px;
				height:25px;
				position:absolute;
				background-color:#bcd;
				bottom:25px;
				left:50px;
				background-image:url(/static/img/s.png);
			}

			footer {
				height: 15px;
				background-color: white;
				color: black;
				border-top: solid black 1px;
				font-size: x-small;
				font-family: Calibri, arial, sans-serif;
				text-align: center;
			}
			.olLayerGoogleV3{
				position:relative;
				float:right;
			}
			
			#search{
				
			}
			
			.btn span{
				width: 25px;
				display: block;
				position: relative;
				float: left;
			}
			
			.is_base_true{
				display: list-item;
				list-style:disc;
			}
			.is_base_false{
				display: list-item;
				list-style:circle;				
			}
			nav{
				width:35px;
				background-color:#ddf;
			}
			.btn{
				display:block;
				height:35px;
				
			}
			.btn:hover{
				background-color:#bbf;
			}
			.btn.selected{
				
				background-color:#99f;
			}
			.btn.erg{
				background-color:#f00;
			}
			.btn.erg:hover{
				background-color:#b22;
			}
			.btn.erg.selected{
				background-color:#933;
			}
			.menu{
				position:relative;
				left:35px;
			}
		</style>
		<script>
			VC = {};
			
			VC.projections ={};
			VC.projections.google = new OpenLayers.Projection("EPSG:900913");
			VC.projections.wgs84 = new OpenLayers.Projection("EPSG:4326");
			
			function createBB(viewport) {
				var bb = new OpenLayers.Bounds();
				bb.extend(new OpenLayers.LonLat(viewport.southwest.lng, viewport.southwest.lat).transform(VC.projections.wgs84, VC.projections.google));
				bb.extend(new OpenLayers.LonLat(viewport.northeast.lng, viewport.northeast.lat).transform(VC.projections.wgs84, VC.projections.google));
				return bb;
			}

			
			VC.refresh = function() {
				$('#map').height($(window).height() - $('header').height() - $('footer').height() - 1);
				$('#map').width($(window).width() - $('nav').width());
				$('nav').height($(window).height()-$('header').height()-$('footer').height()-1);
			}
			
			
       		
			$(window).resize(VC.refresh);
			$(window).hashchange(function() {
				if (location.hash) {
					var loc = location.hash.split('#')[1];
					var op = loc.split(':');
					switch (op[0]) {
						case "goto":
							$.getJSON('/external/maps.googleapis.com/maps/api/geocode/json?sensor=false&address=' + op[1], function(data) {
								VC.map.zoomToExtent(createBB(data.results[0].geometry.viewport));
								$('.area_title').text(data.results[0].address_components[0].long_name);
							})
							break;
						default:
							break;
					}

				}
			});
			VC.showing = true;
			$('#hide_all').live('click', function(){
				if (VC.showing){
					$('.cmd_bar').hide();
					VC.showing = false;
				}
				else{
					$('.cmd_bar').show();
					VC.showing = true;
				}
			});
			
			$('#hide_int').live('click', function(){
				$('#int_ctrl').toggle();
			});
			
			$('.uth').live('click', function(){
				window.location = "/uth";
			});
			
			$('#hide_btm').live('click', function(){
				$('#btm_ctrl').toggle();
			});
			
			$('#op_zoom_in').live('click', function(){
				VC.map.zoomIn();
			});
			
			$('#op_zoom_out').live('click', function(){
				VC.map.zoomOut();
			});
			$('#op_e').live('click', function(){
				VC.map.pan(100,0);
			});
			
			$('#op_w').live('click', function(){
				VC.map.pan(-100,0);
			});
			
			$('#op_n').live('click', function(){
				VC.map.pan(0,-100);
			});
			$('#op_s').live('click', function(){
				VC.map.pan(0,100);
			});
			

			$('.btn').live('click', function(e){
				if ($(this).hasClass('selected')){
					
						$(this).children('.menu').hide();
						$(this).removeClass('selected');
				}else{
					if ($(this).parent().hasClass('btn') && $(this).parent().hasClass('selected')){
						
						$(this).siblings().removeClass('selected');
						$(this).siblings().children('.btn').hide();
						
						$(this).addClass('selected');
						if ($(this).data('show')){
							alert($(this).data('show'));
						}
						$(this).children('.btn').show();
					} else{
						$('.btn').removeClass('selected');
						$('.btn .btn').hide();				
						if ($(this).data('show')){
							alert($(this).data('show'));
						}
						$(this).children('.menu').show();
						$(this).addClass('selected');
					}
				}
				e.preventDefault();
				return false;
			});
			
			$('.area_title').live('click', function(){
				var qloc = $(this).text();
				var p = $(this).parent()
				$(this).remove();
				$('header').append('<input type="text" id="search"></input>').focus();
				
			});
			$('#search').live('keypress', function(event){
				if( event.which == 13 ){
					oloc = location.hash.split(';')[0].split(':')[1];
					lloc = $(this).val();
					$(this).remove();
					$('header').append('<span class="area_title"></span>');
					location.hash="#goto:"+lloc;
					if (oloc == lloc)
						$('.area_title').html(qloc);
				}
			});

				VC.get_data = function(){
					bb = VC.map.getExtent().toGeometry().transform(VC.projections.google,VC.projections.wgs84).getBounds().toBBOX();					
					$.getJSON("/data/instances/visible?BB="+bb, function(data){
						console.log(data);
						VC.geojson_format = new OpenLayers.Format.GeoJSON({'externalProjection':VC.projections.wgs84, 'internalProjection':VC.projections.google});
						proj = VC.geojson_format.read(data);
						console.log(proj);
						VC.vector_layer.removeAllFeatures();
						VC.vector_layer.addFeatures(proj);
					});
				}
				
				VC.style = new OpenLayers.StyleMap({
                "default": new OpenLayers.Style({
                    pointRadius: "5px", 
                    fillColor: "#ffcc66",
                    strokeColor: "#ff9933",
                    strokeWidth: 2,
                    graphicZIndex: 1
                }),
                "select": new OpenLayers.Style({
                    fillColor: "#66ccff",
                    strokeColor: "#3399ff",
                    graphicZIndex: 2
                })
            });

			$(function() {
				$('.menu').hide();
				
				VC.refresh();
				$(window).hashchange();
				VC.map = new OpenLayers.Map('map', {
					controls : [],
					theme:null,
					projection:VC.projections.google
				});
				
       			VC.vector_layer = new OpenLayers.Layer.Vector("elements",{
       				//styleMap:VC.style
       			}); 
       			
       		
				VC.map.addControl(new OpenLayers.Control.Navigation());
				VC.map.addControl(new OpenLayers.Control.DragPan());
				

				var gmap = new OpenLayers.Layer.Google("Google Streets", // the default
				{
					numZoomLevels : 20
				});
				var ghyb = new OpenLayers.Layer.Google("Google Hybrid", {
					type : google.maps.MapTypeId.HYBRID,
					numZoomLevels : 20
				});
				var gsat = new OpenLayers.Layer.Google("Google Satellite", {
					type : google.maps.MapTypeId.SATELLITE,
					numZoomLevels : 20
				});
				VC.map.addLayers([gsat, gmap, ghyb]);
				VC.map.zoomTo(3);
				
           		VC.map.addLayer(VC.vector_layer);
				VC.map.events.register('moveend', VC.map ,	VC.get_data);
				
				VC.selectControl = new OpenLayers.Control.SelectFeature(
	                VC.vector_layer,
	                {
	                    clickout: true, toggle: false,
	                    multiple: false, hover: false,
	                    toggleKey: "ctrlKey", // ctrl key removes from selection
	                    multipleKey: "shiftKey" // shift key adds to selection
	                }
            	);
            
	            VC.map.addControl(VC.selectControl);
	            VC.selectControl.activate();
	            
	            VC.vector_layer.events.on({
                "featureselected": function(e) {
                    var x = e.feature.attributes;
                    list = [];
                    for (var i in x){
                    	list.push(x[i]);
                    }
                    t = list[0].parent_type;
                    $('#btm_ctrl').append(ich.btm_container({'atts':list, 'type':t}));
                },
                "featureunselected": function(e) {
                    $('#btm_ctrl').empty();
                }
            });

			});
		</script>
		<script id="btm_container" type="text/html">
			<h2>{% templatetag openvariable %}type{% templatetag closevariable %}</h2>
			<ul>
				{% templatetag openvariable %}#atts{% templatetag closevariable %}
  					{% templatetag openvariable %}> btm_content{% templatetag closevariable %}
				{% templatetag openvariable %}/atts{% templatetag closevariable %}
			</ul>
		</script>
		<script id="btm_content" class="partial" type="text/html">
			<li data-typeid="{% templatetag openvariable %}data_type_id{% templatetag closevariable %}" class="is_base_{% templatetag openvariable %}is_base{% templatetag closevariable %}" data-type="{% templatetag openvariable %}data_type{% templatetag closevariable %}"><span class="data_name" >{% templatetag openvariable %}name{% templatetag closevariable %}</span>: <span class="vlaue">{% templatetag openvariable %}value{% templatetag closevariable %}</span></li>
		</script>
		
	</head>
	<body>
		<header>
			<span class="main_title">VivaCity</span><span class="area_title"> </span><span class="uth">Under the hood</span>
		</header>
		
		<div id="content" style="z-index:0;">
			<div id="map" style="z-index:0;">
	
			</div>
			
			<div id="nav_ctrl" class="cmd_bar">
				<div id="hide_btm" class="hide_btn"></div> 
				<!--<div id="hide_int" class="hide_btn"></div>-->
				
				<div id="op_zoom_in"></div>
				<div id="op_zoom_out"></div>
				<div id="op_e"></div>
				<div id="op_n"></div>
				<div id="op_s"></div>
				<div id="op_w"></div> 
			</div>
			<div id="btm_ctrl" class="cmd_bar"> </div>
			<div id="hide_all" class="hide_btn"></div> 
		</div>
		<nav id="int_ctrl" class="">
				<div id="env" class="btn">
					<span>Env</span>
					<div class="menu">
					<div id="" class="btn"><span>Trees</span></div>
					<div id="" class="btn"><span>Water</span></div>
					<div id="" class="btn"><span>Pollution</span></div>
					</div>
				</div> 
				<div id="tra" class="btn"> 
					<span>Transport</span>
					<div id="" class="btn"><span>Traffic</span></div>
					<div id="" class="btn"><span>Trains</span></div>
					<div id="" class="btn"><span>Bus</span></div>
					<div id="" class="btn"><span>Metro</span></div>
					<div id="" class="btn"><span>Ship</span></div>
					<div id="" class="btn"><span>Plane</span></div>
					<div id="" class="btn"><span>Taxi</span></div>
				</div> 
				<div id="eco" class="btn">
					<span>Eco</span>
					<div id="" class="btn"><span>Planning</span></div>
					<div id="" class="btn"><span>Licenses</span></div>
					<div id="" class="btn"><span>Inspections</span></div>
				</div> 
				
				<div id="" class="btn">
					<span>Culture</span>
					<div id="" class="btn"><span>Events</span></div>
					<div id="" class="btn"> <span>Museums</span></div>
					<div id="" class="btn">
						<span>Education</span>
						<div id="" class="btn"><span>Schools</span> </div>
						<div id="" class="btn"><span>Workforce</span> </div>
						<div id="" class="btn"> <span>Daycare</span></div> 
					</div>
				</div> 
				<div id="as" class="btn erg"> <span>Crisis</span>
					<div id="" class="btn erg"> Quakes </div>
					<div id="" class="btn erg"> Vulcanic Eruptions </div>
					<div id="" class="btn"> Civil Protection </div> 
				</div> 
			</nav>
		<footer>
			&copy; 2012 MMo.IT
		</footer>
	</body>
</html>